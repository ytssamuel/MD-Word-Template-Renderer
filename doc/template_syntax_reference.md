# Word 模板指令大全

本文件詳細說明 MD-Word Template Renderer 所支援的所有模板語法。模板基於 **Jinja2** 語法，並透過 **docxtpl** 在 Word 文件中實現。

---

## 目錄

1. [變數輸出](#1-變數輸出)
2. [條件判斷](#2-條件判斷)
3. [迴圈處理](#3-迴圈處理)
4. [過濾器](#4-過濾器)
5. [運算與表達式](#5-運算與表達式)
6. [特殊字元處理](#6-特殊字元處理)
7. [進階技巧](#7-進階技巧)
8. [常見問題與錯誤](#8-常見問題與錯誤)
9. [完整範例](#9-完整範例)

---

## 1. 變數輸出

### 1.1 基本變數

使用雙大括號 `{{ }}` 輸出變數值。

```jinja2
系統名稱：{{系統名稱}}
變更單號：{{變更單號}}
日期：{{預定換版日期}}
```

### 1.2 含特殊字元的欄位名稱

當欄位名稱包含 **括號**、**斜線**、**減號** 等特殊字元時，需使用字典存取語法：

```jinja2
{# 含括號的欄位 #}
需求依據：{{data["需求依據(INC/PBI)"]}}
主機名稱：{{data["主機名稱(IP)"]}}

{# 含斜線的欄位 #}
通知方式：{{data["通知/公告方式"]}}
通知內容：{{data["通知/公告內容"]}}

{# 含減號的欄位 #}
異動原因：{{data["通報單-異動原因"]}}
測試案例：{{data["異動內容-測試案例"]}}
```

### 1.3 存取巢狀資料

```jinja2
{# 存取列表中的項目屬性 #}
{{item.value}}
{{item.number}}
{{item.key}}

{# 存取子項目 #}
{{child.value}}
{{child.number}}
```

### 1.4 透過編號存取

資料解析後會自動建立編號索引，可透過 `#編號` 存取：

```jinja2
第一欄位：{{data["#1"].value}}
第一欄位名稱：{{data["#1"].key}}
```

---

## 2. 條件判斷

### 2.1 基本 if 判斷

```jinja2
{% if 中介軟體 %}
中介軟體設定：{{中介軟體}}
{% endif %}
```

### 2.2 if-else 判斷

```jinja2
{% if 中介軟體 %}
中介軟體：{{中介軟體}}
{% else %}
中介軟體：無
{% endif %}
```

### 2.3 if-elif-else 判斷

```jinja2
{% if 計畫性維護 == "是" %}
狀態：已排定維護
{% elif 計畫性維護 == "否" %}
狀態：未排定
{% else %}
狀態：待確認
{% endif %}
```

### 2.4 多條件判斷

#### and（且）
```jinja2
{% if 中介軟體 and 資料庫 %}
兩者都有設定
{% endif %}
```

#### or（或）
```jinja2
{% if 中介軟體 or 資料庫 %}
至少有一項設定
{% endif %}
```

#### not（非）
```jinja2
{% if not 中介軟體 %}
尚未設定中介軟體
{% endif %}
```

### 2.5 判斷是否為空

```jinja2
{# 判斷字串是否為空 #}
{% if 備註 %}有備註{% endif %}
{% if 備註 == "" %}備註為空{% endif %}

{# 判斷列表是否為空 #}
{% if data["異動內容-測試案例"] %}
有測試案例
{% endif %}

{% if data["異動內容-測試案例"]|length > 0 %}
測試案例數量：{{data["異動內容-測試案例"]|length}}
{% endif %}
```

### 2.6 判斷是否存在

```jinja2
{% if 選填欄位 is defined %}
選填欄位存在：{{選填欄位}}
{% endif %}

{% if 選填欄位 is not defined %}
選填欄位不存在
{% endif %}
```

### 2.7 比較運算子

| 運算子 | 說明 | 範例 |
|--------|------|------|
| `==` | 等於 | `{% if x == "值" %}` |
| `!=` | 不等於 | `{% if x != "" %}` |
| `>` | 大於 | `{% if count > 5 %}` |
| `<` | 小於 | `{% if count < 10 %}` |
| `>=` | 大於等於 | `{% if count >= 1 %}` |
| `<=` | 小於等於 | `{% if count <= 100 %}` |
| `in` | 包含 | `{% if "關鍵字" in 內容 %}` |
| `not in` | 不包含 | `{% if "排除" not in 內容 %}` |

---

## 3. 迴圈處理

### 3.1 基本 for 迴圈

```jinja2
{% for item in data["異動內容-測試案例"] %}
{{loop.index}}. {{item.value}}
{% endfor %}
```

### 3.2 迴圈變數

在 `{% for %}` 迴圈中可用的特殊變數：

| 變數 | 說明 | 範例值 |
|------|------|--------|
| `loop.index` | 從 1 開始的索引 | 1, 2, 3... |
| `loop.index0` | 從 0 開始的索引 | 0, 1, 2... |
| `loop.revindex` | 反向索引（到 1） | 5, 4, 3, 2, 1 |
| `loop.revindex0` | 反向索引（到 0） | 4, 3, 2, 1, 0 |
| `loop.first` | 是否為第一項 | True/False |
| `loop.last` | 是否為最後一項 | True/False |
| `loop.length` | 列表總長度 | 5 |
| `loop.cycle` | 循環取值 | 見下方範例 |
| `loop.depth` | 巢狀深度（從 1 開始） | 1, 2, 3... |
| `loop.depth0` | 巢狀深度（從 0 開始） | 0, 1, 2... |

### 3.3 巢狀迴圈

處理有子項目的資料結構：

```jinja2
{% for item in data["異動內容-測試案例"] %}
{{item.number}}. {{item.value}}
  {% for child in item.children %}
  {{child.number}}. {{child.value}}
  {% endfor %}
{% endfor %}
```

### 3.4 條件式迴圈

```jinja2
{# 只處理符合條件的項目 #}
{% for item in data["異動內容-測試案例"] if item.value %}
{{loop.index}}. {{item.value}}
{% endfor %}
```

### 3.5 迴圈中的條件

```jinja2
{% for item in data["異動內容-測試案例"] %}
  {% if loop.first %}【第一項】{% endif %}
  {{loop.index}}. {{item.value}}
  {% if loop.last %}【最後一項】{% endif %}
{% endfor %}
```

### 3.6 空列表處理

```jinja2
{% for item in data["異動內容-測試案例"] %}
{{loop.index}}. {{item.value}}
{% else %}
（無測試案例）
{% endfor %}
```

### 3.7 循環樣式（交替）

```jinja2
{% for item in data["異動內容-測試案例"] %}
{{loop.cycle('奇數行', '偶數行')}}：{{item.value}}
{% endfor %}
```

### 3.8 限制迴圈次數

```jinja2
{# 只顯示前 5 項 #}
{% for item in data["異動內容-測試案例"][:5] %}
{{loop.index}}. {{item.value}}
{% endfor %}

{# 跳過前 2 項 #}
{% for item in data["異動內容-測試案例"][2:] %}
{{loop.index}}. {{item.value}}
{% endfor %}
```

---

## 4. 過濾器

過濾器用於處理和轉換變數值，語法：`{{變數|過濾器}}`

### 4.1 預設值

```jinja2
{# 當變數為空時顯示預設值 #}
{{中介軟體|default("無")}}
{{備註|default("暫無備註")}}
{{數量|default(0)}}
```

### 4.2 字串處理

```jinja2
{# 轉大寫 #}
{{狀態|upper}}

{# 轉小寫 #}
{{狀態|lower}}

{# 首字大寫 #}
{{名稱|capitalize}}

{# 每個單字首字大寫 #}
{{名稱|title}}

{# 去除頭尾空白 #}
{{內容|trim}}

{# 截斷字串 #}
{{說明|truncate(50)}}          {# 最多 50 字 #}
{{說明|truncate(50, true)}}    {# 截斷到完整單字 #}
{{說明|truncate(50, true, '...')}}  {# 自訂省略符號 #}

{# 取代字串 #}
{{內容|replace("舊文字", "新文字")}}

{# 移除 HTML 標籤 #}
{{html內容|striptags}}
```

### 4.3 數值處理

```jinja2
{# 絕對值 #}
{{數值|abs}}

{# 四捨五入 #}
{{數值|round}}           {# 整數 #}
{{數值|round(2)}}        {# 小數點後 2 位 #}
{{數值|round(2, 'floor')}}  {# 無條件捨去 #}
{{數值|round(2, 'ceil')}}   {# 無條件進位 #}

{# 整數 #}
{{數值|int}}

{# 浮點數 #}
{{數值|float}}

{# 格式化數字 #}
{{金額|format}}
```

### 4.4 列表處理

```jinja2
{# 取得長度 #}
{{列表|length}}

{# 第一個項目 #}
{{列表|first}}

{# 最後一個項目 #}
{{列表|last}}

{# 反轉列表 #}
{{列表|reverse}}

{# 排序 #}
{{列表|sort}}
{{列表|sort(attribute='value')}}  {# 依屬性排序 #}
{{列表|sort(reverse=true)}}       {# 反向排序 #}

{# 合併為字串 #}
{{列表|join(", ")}}
{{列表|join("\n")}}

{# 取得唯一值 #}
{{列表|unique}}

{# 隨機取一個 #}
{{列表|random}}

{# 加總（數值列表） #}
{{數值列表|sum}}

{# 最大值 / 最小值 #}
{{數值列表|max}}
{{數值列表|min}}
```

### 4.5 日期時間

```jinja2
{# 需搭配 Python datetime 物件 #}
{{日期|string}}
```

### 4.6 安全輸出

```jinja2
{# 跳過 HTML 轉義 #}
{{html內容|safe}}

{# 強制 HTML 轉義 #}
{{內容|e}}
{{內容|escape}}
```

### 4.7 鏈式過濾器

可串接多個過濾器：

```jinja2
{{名稱|trim|upper|truncate(20)}}
{{列表|sort|first}}
{{內容|default("無")|upper}}
```

---

## 5. 運算與表達式

### 5.1 數學運算

```jinja2
{# 基本運算 #}
{{數量 + 10}}
{{價格 - 折扣}}
{{單價 * 數量}}
{{總額 / 人數}}
{{總數 // 組數}}    {# 整數除法 #}
{{數值 % 2}}        {# 取餘數 #}
{{2 ** 10}}         {# 次方 #}
```

### 5.2 字串運算

```jinja2
{# 字串連接 #}
{{姓 ~ 名}}
{{"前綴" ~ 變數 ~ "後綴"}}
```

### 5.3 設定變數

```jinja2
{% set 總數 = data["異動內容-測試案例"]|length %}
測試案例總數：{{總數}}

{% set 顯示名稱 = 系統名稱|default("未命名系統") %}
系統：{{顯示名稱}}
```

### 5.4 三元運算子

```jinja2
{{中介軟體 if 中介軟體 else "無"}}
{{"是" if 已完成 else "否"}}
```

---

## 6. 特殊字元處理

### 6.1 Markdown 資料中的轉義

在 Markdown 資料檔案中，使用反斜線轉義特殊字元：

| 轉義序列 | 結果 | 說明 |
|----------|------|------|
| `\|` | `|` | 管線符號（欄位分隔符） |
| `\n` | 換行 | 換行符號 |
| `\\` | `\` | 反斜線 |
| `\'` | `'` | 單引號 |
| `\"` | `"` | 雙引號 |

### 6.2 模板中的特殊字元

```jinja2
{# 輸出大括號 #}
{{ "{{" }}這不是變數{{ "}}" }}

{# 或使用 raw 區塊 #}
{% raw %}
這裡的 {{變數}} 不會被解析
{% endraw %}
```

### 6.3 註解

```jinja2
{# 這是單行註解，不會輸出到文件 #}

{#
  這是
  多行註解
#}
```

---

## 7. 進階技巧

### 7.1 巨集（可重用區塊）

```jinja2
{# 定義巨集 #}
{% macro render_item(item) %}
  {{item.number}}. {{item.value}}
{% endmacro %}

{# 使用巨集 #}
{% for item in data["異動內容-測試案例"] %}
  {{ render_item(item) }}
{% endfor %}
```

### 7.2 帶參數的巨集

```jinja2
{% macro field(label, value, default_text="無") %}
{{label}}：{{value|default(default_text)}}
{% endmacro %}

{{ field("系統名稱", 系統名稱) }}
{{ field("中介軟體", 中介軟體, "未設定") }}
```

### 7.3 區塊繼承（進階）

在複雜模板中，可定義可覆寫區塊：

```jinja2
{# 基礎模板區塊 #}
{% block 標題 %}
預設標題
{% endblock %}

{% block 內容 %}
預設內容
{% endblock %}
```

### 7.4 空白控制

```jinja2
{# 移除標籤前後空白 #}
{%- if 條件 -%}
內容
{%- endif -%}

{# 只移除前方空白 #}
{%- if 條件 %}

{# 只移除後方空白 #}
{% if 條件 -%}
```

### 7.5 全域函數

```jinja2
{# 產生數字範圍 #}
{% for i in range(5) %}
  項目 {{i}}
{% endfor %}

{% for i in range(1, 10) %}
  {{i}}
{% endfor %}

{% for i in range(0, 10, 2) %}  {# 間隔 2 #}
  {{i}}
{% endfor %}

{# 取得字典的鍵/值 #}
{% for key, value in data.items() %}
  {{key}}: {{value}}
{% endfor %}
```

---

## 8. 常見問題與錯誤

### 8.1 `'xxx' is undefined`

**原因**：模板中使用的變數在資料中不存在

**解決方案**：
1. 檢查 Markdown 資料是否包含該欄位
2. 使用 `default` 過濾器提供預設值
3. 使用條件判斷檢查是否存在

```jinja2
{# 方案 1：使用 default #}
{{可能不存在的欄位|default("")}}

{# 方案 2：條件判斷 #}
{% if 可能不存在的欄位 is defined %}
  {{可能不存在的欄位}}
{% endif %}
```

### 8.2 特殊字元欄位名稱錯誤

**原因**：欄位名稱含括號、斜線等特殊字元

**解決方案**：使用 `data["欄位名稱"]` 語法

```jinja2
{# 錯誤 #}
{{需求依據(INC/PBI)}}
{{通知/公告方式}}

{# 正確 #}
{{data["需求依據(INC/PBI)"]}}
{{data["通知/公告方式"]}}
```

### 8.3 迴圈無法執行

**原因**：變數不是列表類型

**解決方案**：確認資料結構，檢查是否有子項目

```jinja2
{# 先檢查是否為列表 #}
{% if data["異動內容-測試案例"] is iterable %}
  {% for item in data["異動內容-測試案例"] %}
    {{item.value}}
  {% endfor %}
{% endif %}
```

### 8.4 空值顯示 `None`

**原因**：變數值為 Python 的 None

**解決方案**：使用 default 過濾器

```jinja2
{{可能為None的值|default("")}}
```

### 8.5 數字無法計算

**原因**：變數是字串類型

**解決方案**：使用 int 或 float 過濾器轉換

```jinja2
{{數量|int + 10}}
{{價格|float * 1.05}}
```

---

## 9. 完整範例

### 9.1 基本變更單模板

```jinja2
變更作業確認單
================

一、基本資訊
系統名稱：{{系統名稱}}
變更單號：{{變更單號}}
需求依據：{{data["需求依據(INC/PBI)"]|default("無")}}
預定日期：{{預定換版日期}}
變更時段：{{預定變更時段}}
備援路徑：{{備援路徑}}

二、相關系統
資料庫：{{資料庫|default("無")}}
中介軟體：{{中介軟體|default("無")}}
網路設定：{{data["網路(含防火牆)"]|default("無")}}
其他系統：{{其他系統|default("無")}}

三、通知資訊
計畫性維護：{{計畫性維護}}
通知對象：{{通知對象}}
通知方式：{{data["通知/公告方式"]}}
通知內容：{{data["通知/公告內容"]}}

四、異動原因
{{data["通報單-異動原因"]}}

五、測試案例
{% for item in data["異動內容-測試案例"] %}
{{item.number}}. {{item.value}}
{% for child in item.children %}
   {{child.number}}. {{child.value}}
{% endfor %}
{% endfor %}

六、測試環境
測試日期：{{測試日期}}
主機名稱：{{data["主機名稱(IP)"]}}
作業系統：{{作業系統}}
瀏覽器：{{瀏覽器}}
測試網址：{{測試網址}}
測試參數：{{測試參數}}

--- 文件結束 ---
```

### 9.2 條件式內容模板

```jinja2
變更摘要
========

系統：{{系統名稱}}
單號：{{變更單號}}

【狀態檢核】
{% if 資料庫 %}✅{% else %}❌{% endif %} 資料庫設定
{% if 中介軟體 %}✅{% else %}❌{% endif %} 中介軟體設定  
{% if data["網路(含防火牆)"] %}✅{% else %}❌{% endif %} 網路設定
{% if 計畫性維護 %}✅{% else %}❌{% endif %} 計畫性維護

【測試案例統計】
{% set test_count = data["異動內容-測試案例"]|length %}
總計：{{test_count}} 項測試案例

{% if test_count > 0 %}
測試項目清單：
{% for item in data["異動內容-測試案例"] %}
  {{loop.index}}/{{loop.length}} {{item.value}}
  {% if item.children %}
    （含 {{item.children|length}} 個子項目）
  {% endif %}
{% endfor %}
{% else %}
（無測試案例）
{% endif %}
```

### 9.3 表格化輸出模板

```jinja2
測試案例明細表
==============

{% for item in data["異動內容-測試案例"] %}
┌─────────────────────────────────────────┐
│ 測試案例 {{loop.index}}：{{item.value}}
├─────────────────────────────────────────┤
{% if item.children %}
│ 子項目：
{% for child in item.children %}
│   {{child.number}}. {{child.value}}
{% endfor %}
{% else %}
│ （無子項目）
{% endif %}
└─────────────────────────────────────────┘

{% endfor %}
```

---

## 附錄：快速參考卡

### 輸出

| 語法 | 說明 |
|------|------|
| `{{變數}}` | 輸出變數 |
| `{{data["特殊欄位"]}}` | 輸出含特殊字元的欄位 |
| `{{變數\|過濾器}}` | 帶過濾器輸出 |

### 條件

| 語法 | 說明 |
|------|------|
| `{% if 條件 %}...{% endif %}` | 條件判斷 |
| `{% if 條件 %}...{% else %}...{% endif %}` | if-else |
| `{% if 條件 %}...{% elif 條件 %}...{% endif %}` | if-elif |

### 迴圈

| 語法 | 說明 |
|------|------|
| `{% for x in 列表 %}...{% endfor %}` | 迴圈 |
| `{% for x in 列表 %}...{% else %}...{% endfor %}` | 帶空列表處理 |
| `loop.index` | 從 1 開始的索引 |
| `loop.first` / `loop.last` | 第一項/最後一項 |

### 常用過濾器

| 過濾器 | 說明 |
|--------|------|
| `default(值)` | 預設值 |
| `length` | 長度 |
| `upper` / `lower` | 大小寫 |
| `trim` | 去空白 |
| `first` / `last` | 第一/最後項 |
| `join(分隔符)` | 合併列表 |
| `sort` | 排序 |

---

*文件版本：1.0*  
*最後更新：2025-12*
