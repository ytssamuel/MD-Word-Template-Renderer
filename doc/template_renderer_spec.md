# Markdown to Word 模板渲染系統 - 需求規劃

## 專案概述

將結構化的 Markdown 資料套用至 Word 模板，實現類似 Vue.js 的模板渲染機制。

**核心概念：** `Markdown 資料 + Word Template = 渲染完成的 Word 文件`

---

## 一、資料格式分析

### 1.1 Markdown 資料結構

根據提供的範例 `OH_20251020.md`，資料格式如下：

```
編號. 欄位名稱 | 值
```

**特徵：**
- **簡單欄位**：`1. 系統名稱 | Super E-Billing 帳款管理系統`
- **空值欄位**：`8. 中介軟體 | ` (值為空)
- **多行值**：使用縮排表示子層級
  ```
  16. 異動內容-測試案例 | 
      1. 調整供應商登入之密碼功能
         1. TC001：新增供應商使用者
         2. TC002：超過最長使用設定
  ```
- **階層結構**：透過縮排（空格或 Tab）表示父子關係

### 1.2 資料結構建模

建議解析為 JSON 結構：

```json
{
  "1": {
    "key": "系統名稱",
    "value": "Super E-Billing 帳款管理系統"
  },
  "16": {
    "key": "異動內容-測試案例",
    "value": "",
    "children": [
      {
        "number": "1",
        "value": "調整供應商登入之密碼功能",
        "children": [
          {"number": "1", "value": "TC001：新增供應商使用者"},
          {"number": "2", "value": "TC002：超過最長使用設定"}
        ]
      }
    ]
  }
}
```

---

## 二、Word 模板語法設計

### 2.1 基本置換語法

#### 語法 1：簡單變數置換
```
{{變數名稱}}
```

**範例：**
- Word 模板：`系統名稱：{{系統名稱}}`
- 渲染結果：`系統名稱：Super E-Billing 帳款管理系統`

**實作對應：**
- `{{系統名稱}}` → 查找 markdown 中 "系統名稱" 欄位的值

#### 語法 2：使用編號存取
```
{{#編號}}
```

**範例：**
- `{{#1}}` → 取得編號 1 的值（系統名稱的值）
- `{{#1.key}}` → 取得編號 1 的欄位名稱
- `{{#1.value}}` → 取得編號 1 的值

### 2.2 條件渲染

```
{{#if 變數名稱}}
內容
{{/if}}
```

**範例：**
```
{{#if 中介軟體}}
中介軟體：{{中介軟體}}
{{/if}}
```
- 如果欄位有值才顯示，否則整段不渲染

### 2.3 列表渲染（迴圈）

#### 語法：單層列表
```
{{#each 變數名稱}}
{{index}}. {{value}}
{{/each}}
```

**範例：**
```
測試案例：
{{#each 異動內容-測試案例}}
  {{number}}. {{value}}
{{/each}}
```

**渲染結果：**
```
測試案例：
  1. 調整供應商登入之密碼功能
  2. 調整中華電信解析錯誤文字格式
  3. 修復中華電信子公司受理分行無法使用...
```

#### 語法：巢狀列表
```
{{#each 變數名稱}}
  {{number}}. {{value}}
  {{#each children}}
    {{number}}. {{value}}
  {{/each}}
{{/each}}
```

**範例：完整多層級渲染**
```
異動內容：
{{#each 異動內容-測試案例}}
{{index}}. {{value}}
{{#each children}}
   {{index}}. {{value}}
{{/each}}
{{/each}}
```

### 2.4 進階功能（第二階段）

#### 表格渲染
```
{{#table 變數名稱}}
| 編號 | 項目 | 說明 |
{{/table}}
```

#### 圖片插入（已實作）

**Markdown 語法：**
```markdown
![替代文字](圖片路徑)
```

**範例：**
```markdown
16. 異動內容-測試案例 | 
    1. 功能測試
       1. ![screenshot](images/test_001.png)
```

**解析結果：**
- `type`: "image"
- `value`: "screenshot" (替代文字)
- `image_path`: 絕對路徑
- `image_alt`: "screenshot"

**Word 模板中使用：**
```jinja2
{% for item in data["異動內容-測試案例"] %}
  {% if item.type == "image" %}
    {{item.value}}  {# 自動渲染為圖片 #}
  {% endif %}
{% endfor %}
```

---

## 三、實作流程規劃

### 3.1 整體流程

```
1. 讀取 Markdown 檔案
   ↓
2. 解析 Markdown 結構
   ├─ 識別編號、欄位名稱、值
   ├─ 建立階層關係
   └─ 轉換為內部資料結構（JSON）
   ↓
3. 讀取 Word 模板
   ↓
4. 掃描模板中的置換標記
   ├─ {{變數}}
   ├─ {{#if}}...{{/if}}
   └─ {{#each}}...{{/each}}
   ↓
5. 執行渲染
   ├─ 簡單置換
   ├─ 條件判斷
   └─ 迴圈展開
   ↓
6. 輸出渲染後的 Word 檔案
```

### 3.2 技術選型建議

#### Python 套件
1. **python-docx** - Word 文件操作
   - 優點：純 Python、輕量、易用
   - 缺點：功能較基礎
   
2. **python-docx-template** - 模板引擎
   - 內建 Jinja2 風格的模板語法
   - 支援 {{變數}}、{% for %}、{% if %} 等
   
3. **docxtpl** - 進階模板引擎
   - 基於 python-docx 和 Jinja2
   - 支援複雜的模板邏輯

#### Markdown 解析
- 自行實作解析器（推薦，因為格式特殊）
- 使用正則表達式匹配 `編號. 名稱 | 值`

---

## 四、模板設計範例

### 4.1 Word 模板示意

**檔名：** `change_request_template.docx`

```
變更單資料

系統名稱：{{系統名稱}}
預定換版日期：{{預定換版日期}}
預定變更時段：{{預定變更時段}}
變更單號：{{變更單號}}

異動內容-測試案例：
{{#each 異動內容-測試案例}}
{{number}}. {{value}}
{{#each children}}
   {{number}}. {{value}}
{{/each}}

{{/each}}

測試資訊：
- 測試日期：{{測試日期}}
- 主機名稱(IP)：{{主機名稱(IP)}}
- 作業系統：{{作業系統}}
```

### 4.2 語法規則總結

| 語法 | 用途 | 範例 |
|------|------|------|
| `{{變數}}` | 簡單置換 | `{{系統名稱}}` |
| `{{#編號}}` | 用編號存取 | `{{#1}}` |
| `{{#if 變數}}...{{/if}}` | 條件渲染 | `{{#if 中介軟體}}有值{{/if}}` |
| `{{#each 變數}}...{{/each}}` | 列表迴圈 | `{{#each 異動內容-測試案例}}...{{/each}}` |
| `{{index}}`/`{{number}}` | 迴圈中的索引 | 在 each 內使用 |
| `{{value}}` | 迴圈中的值 | 在 each 內使用 |
| `{{children}}` | 存取子層級 | `{{#each children}}` |

---

## 五、開發階段規劃

### Phase 1：核心功能（MVP）
- [x] 需求分析與規劃
- [ ] Markdown 解析器
  - [ ] 單層資料解析
  - [ ] 多層階層解析
  - [ ] 轉換為 JSON 結構
- [ ] 簡單置換功能
  - [ ] `{{變數}}` 語法
  - [ ] `{{#編號}}` 語法
- [ ] Word 模板讀寫
  - [ ] 讀取 .docx
  - [ ] 查找並替換文字
  - [ ] 輸出新的 .docx

### Phase 2：進階功能
- [ ] 條件渲染 `{{#if}}`
- [ ] 列表渲染 `{{#each}}`
- [ ] 巢狀迴圈支援
- [ ] 錯誤處理與日誌

### Phase 3：擴充功能（待辦）
- [ ] 表格渲染
- [x] 圖片插入
- [ ] 自訂格式（粗體、顏色等）
- [ ] 樣式保留

---

## 六、問題與討論

### Q1: 模板語法選擇
**問題：** 建議使用 `{{變數}}` 類似 Mustache/Handlebars 的語法，還是 `{變數}` 更簡潔的語法？

**目前建議：** `{{變數}}` - 因為：
1. 與主流模板引擎一致（Vue、Handlebars）
2. 減少與一般文字衝突
3. 易於視覺識別

**您的意見：** __按照建議的實作___________

---

### Q2: 階層資料存取方式
**問題：** 對於多層級資料，是否需要支援點記法存取？

**範例：**
- `{{異動內容-測試案例.1.children.1.value}}`
- 或只透過 `{{#each}}` 迴圈逐層存取？

**您的意見：** __是___________

---

### Q3: 欄位名稱與編號
**問題：** 應該用欄位名稱還是編號作為主要存取方式？

**選項：**
1. **欄位名稱優先**：`{{系統名稱}}`（更直觀）
2. **編號優先**：`{{#1}}`（更穩定，不怕改名）
3. **兩者都支援**：`{{系統名稱}}` 或 `{{#1}}`

**目前建議：** 兩者都支援，但推薦使用欄位名稱

**您的意見：** __兩者都支援___________

---

### Q4: 空值處理
**問題：** 當欄位值為空時（如 `8. 中介軟體 | `），應該如何處理？

**選項：**
1. 顯示空白
2. 顯示預設文字（如 "無"）
3. 完全不渲染該行

**範例需求：**
```
{{中介軟體 | default="無"}}
```

**您的意見：** ____顯示空白_________

---

### Q5: 迴圈變數名稱
**問題：** 在 `{{#each}}` 內部，使用什麼變數名稱存取當前項目？

**建議：**
- `{{number}}` - 項目編號
- `{{value}}` - 項目內容
- `{{children}}` - 子項目
- `{{index}}` - 迴圈索引（0, 1, 2...）

**是否需要其他變數？**

**您的意見：** ___否__________

---

### Q6: 縮排與格式
**問題：** 在 Word 中處理縮排時，應該：

**選項：**
1. 由模板控制（在 Word 模板中手動設定縮排）
2. 由語法控制（如 `{{#each 異動內容-測試案例 indent=2}}`）
3. 自動根據階層深度縮排

**您的意見：** ____1_________

---

### Q7: 特殊字元處理
**問題：** Markdown 中的特殊字元（如 `|`、`:`、換行）應如何保留到 Word？

**您的意見：** ____可像程式語言一樣 有反斜線的機制 或是 “”代表一個“________

---

### Q8: 錯誤處理策略
**問題：** 當模板中引用不存在的變數時：

**選項：**
1. 保留原樣（`{{不存在的變數}}`）
2. 替換為空白
3. 拋出錯誤並停止
4. 顯示錯誤訊息（`[ERROR: 變數不存在]`）

**您的意見：** _____4________

---

## 七、使用範例

### 7.1 基本使用流程

```python
# 假設的 API 設計
from md_word_renderer import MarkdownParser, WordRenderer

# 1. 解析 Markdown
parser = MarkdownParser()
data = parser.parse("OH_20251020.md")

# 2. 渲染 Word
renderer = WordRenderer()
renderer.load_template("template.docx")
renderer.render(data)
renderer.save("output.docx")
```

### 7.2 命令列使用

```bash
python render.py --markdown OH_20251020.md --template template.docx --output result.docx
```

---

## 八、附錄

### A. Markdown 範例分析

從 `OH_20251020.md` 觀察到的結構：

```
第一層（無縮排）：
1. 系統名稱 | Super E-Billing 帳款管理系統
16. 異動內容-測試案例 | 

第二層（4 空格縮排）：
    1. 調整供應商登入之密碼功能

第三層（7 空格縮排）：
       1. TC001：新增供應商使用者
```

**縮排規則待確認：**
- 是否統一使用 4 空格？
- 是否支援 Tab？
- 混合空格與 Tab 如何處理？ 統一回覆：可參考python空格or tab的機制實作

---

### B. 技術實作建議細節

#### B.1 Markdown 解析策略
```python
# 偽代碼
def parse_line(line):
    # 1. 計算縮排層級
    indent_level = count_leading_spaces(line) // 4
    
    # 2. 匹配格式
    match = re.match(r'(\d+)\.\s+([^|]+)\s*\|\s*(.*)', line)
    if match:
        number, key, value = match.groups()
        return {
            'level': indent_level,
            'number': number,
            'key': key.strip(),
            'value': value.strip()
        }
```

#### B.2 Word 渲染策略
```python
# 使用 python-docx
from docx import Document

doc = Document('template.docx')

for paragraph in doc.paragraphs:
    # 查找 {{...}} 並替換
    text = paragraph.text
    for match in re.finditer(r'\{\{(.+?)\}\}', text):
        variable = match.group(1)
        value = data.get(variable, '')
        text = text.replace(match.group(0), value)
    paragraph.text = text
```

---

## 九、後續討論事項

請您回答以上 Q1-Q8 的問題，以及：

1. **優先級排序**：Phase 1 中的功能，您希望優先實作哪些？ 都需要實作，這是核心功能
2. **其他需求**：是否有未列出的功能需求？這也是列在未來的擴充，當前是實作資料+模板＝渲染完成，未來可實作完成的word檔＋模板＝資料的逆向轉換。
3. **模板範例**：是否需要我先製作一個 Word 模板範例？可以
4. **測試資料**：除了 `OH_20251020.md`，是否還有其他範例資料？無
5. 補充 請使用docxtpl作爲模板引擎，應該會省去不少工作

---

**文件版本：** v1.0  
**建立日期：** 2025-12-12  
**待更新：** 根據討論結果更新設計細節
